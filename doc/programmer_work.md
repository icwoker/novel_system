---

### 🛠 一、 技术栈选型 (Tech Stack)

既然核心框架你定了，为了保证性能和开发效率，我们配套的库也选好了：

**前端 (Frontend)**
* **核心框架：** `Vite` + `React` (TS) + `Zustand` (状态管理，你指定的)
* **UI 框架：** `Tailwind CSS` + `Shadcn/ui` (快速构建好看的界面)
* **编辑器内核：** `Tiptap` (Headless Editor，支持 Markdown 和 AI 扩展)
* **可视化图表：** `React Flow` (专门用于做人物关系图)
* **网络请求：** `Axios` + `React Query` (处理服务端状态和缓存)

**后端 (Backend)**
* **核心框架：** `FastAPI` (Python, 异步高性能，你指定的)
* **数据库：** `PostgreSQL` (稳定可靠，你指定的)
* **ORM：** `SQLAlchemy` (处理数据库交互)
* **文档处理：** `python-docx` (处理 Word 导出)
* **AI 交互：** `OpenAI SDK` + `LangChain` (可选，用于后续复杂的 Context 处理)

---

### 📋 二、 V1.0 功能优先级总表 (Master Feature List)

**优先级定义：**
* 🔴 **P0 (MVP 核心 - Blocker):** 不做完不许上线，系统跑不通。
* 🟡 **P1 (V1.0 必备 - Essential):** 必须有，虽然不阻碍流程跑通，但缺了会被骂“残次品”。
* ⚪ **P2 (V1.1 规划):** 延后开发，本期不碰。

#### 1. 用户与权限 (User & Auth)

| ID | 功能点 | 优先级 | 研发确认方案 |
| :--- | :--- | :--- | :--- |
| **U-01** | **注册/登录** | 🔴 **P0** | 邮箱+密码，JWT Token 鉴权。 |
| **U-02** | **个人设置** | 🔴 **P0** | 修改昵称、头像（仅支持 URL 或系统预设，暂不接文件上传存储）。 |
| **U-03** | **API Key 管理** | 🔴 **P0** | **方案确认：** 用户填入 Key -> 前端使用 UserID 简易混淆加密 -> 存入 LocalStorage。**后端不存库**，仅做透传。 |
| **U-04** | **密码修改** | ⚪ **P2** | V1.0 暂不支持自助找回，仅支持登录状态下修改。 |
| :--- | :--- | :--- | :--- |
| **U-05** | **会员订阅** | 🟡 **P1** | **DB 变更：** `users` 表增加 `subscription_tier` (Free/Pro) 和 `balance` (额度) 字段。 |


#### 2. 小说管理 (Novel Management)

| ID | 功能点 | 优先级 | 研发确认方案 |
| :--- | :--- | :--- | :--- |
| **N-01** | **书架列表** | 🔴 **P0** | 展示书籍卡片，基本的增删改查 (CRUD)。 |
| **N-02** | **目录管理** | 🔴 **P0** | 卷/章两级结构，支持拖拽排序 (dnd-kit)。 |
| **N-03** | **回收站** | 🟡 **P1** | 软删除机制 (`is_deleted`)，防止误删。 |
| **N-04** | **导出/下载** | 🟡 **P1** | **方案确认：** 支持导出 TXT 和 Word。后端解析 Markdown 生成 `.docx` 文件流。 |

#### 3. 核心编辑器 (Writer Core)

| ID | 功能点 | 优先级 | 研发确认方案 |
| :--- | :--- | :--- | :--- |
| **E-01** | **富文本写作** | 🔴 **P0** | 基于 Tiptap。支持 H1-H3, 加粗, 撤销/重做。 |
| **E-02** | **断网保护** | 🔴 **P0** | **方案确认：** 写入 LocalStorage。联网同步时，**以前端最新时间戳内容强行覆盖后端** (Last Write Wins)。 |
| **E-03** | **自动保存** | 🔴 **P0** | 防抖 (Debounce) 2秒自动提交保存。 |
| **E-04** | **AI 辅助菜单** | 🔴 **P0** | 选中文字弹出 Bubble Menu，支持“润色、续写”。 |
| **E-05** | **全屏/夜间模式**| 🟡 **P1** | 纯前端 CSS 样式切换，提升体验。 |
| **E-06** | **实时字数** | 🔴 **P0** | **前端实现：** Tiptap 自带 `CharacterCount` 扩展，纯前端实时统计，不耗后端资源。 |

#### 4. 世界观与设定 (World Bible)

| ID | 功能点 | 优先级 | 研发确认方案 |
| :--- | :--- | :--- | :--- |
| **W-01** | **人物卡片** | 🔴 **P0** | 姓名、性别、立绘 URL、文字描述。 |
| **W-02** | **人物关系图** | 🟡 **P1** | **方案确认：** 使用 `React Flow`。支持增删连线。**V1.0 不做自动布局**，用户手动拖拽位置保存。 |
| **W-03** | **分卷大纲** | 🟡 **P1** | 独立于正文的文本框，按卷存储。 |
| **W-04** | **地点/物品库** | 🟡 **P1** | **DB 变更：** 新增 `locations` 和 `items` 表，结构参考人物表（名称/描述/图片）。 |
| **W-05** | **侧边参考栏** | ⚪ **P2** | **前端实现：** 使用 `react-resizable-panels` 实现可拖拽调节宽度的右侧栏。 |

#### 5. AI 服务中台 (AI Copilot)

| ID | 功能点 | 优先级 | 研发确认方案 |
| :--- | :--- | :--- | :--- |
| **A-01** | **流式接口** | 🔴 **P0** | SSE (Server-Sent Events) 实现打字机效果。 |
| **A-02** | **Prompt 组装** | 🔴 **P0** | 后端自动拼接：`System Prompt` + `人物小传` + `选中文字`。 |
| **A-03** | **渠道路由** | 🔴 **P0** | 优先读取 Request Header 里的用户 Key，无 Key 则拦截或使用平台试用 Key。 |
| **A-04** | **Token 监控** | 🟡 **P1** | **后端实现：** FastAPI Middleware 拦截器。请求结束时，解析 AI 响应的 usage 字段，异步更新用户余额。 |
| **A-05** | **起名助手** | 🟡 **P1** | **Prompt 工程：** 预设“玄幻/都市/古言”起名模板，前端调用专用 API `/api/ai/naming`。 |
| **A-06** | **剧情生成** | 🟡 **P1** | **后端实现：** 需处理长文本 Context。我们会截取最近 3000 字 + 大纲作为 Prompt 发送。 |

#### 6. 移动端兼容 (Mobile) - 补充

| ID | 功能点 | 优先级 | 研发确认方案 |
| :--- | :--- | :--- | :--- |
| **M-01** | **API 兼容性** | 🔴 **P0** | **架构确认：** FastAPI 默认全 JSON 响应，天然前后端分离，无 SSR 负担。 |
| **M-02** | **H5 适配** | 🟡 **P1** | **UI 实现：** Tailwind CSS 响应式类 (`md:hidden`, `lg:flex`)，保证手机上能看见内容和编辑内容。 |
| **M-03** | **React Native** | ⚪ **P2** | **规划：** 暂不开发，仅预留接口。 |
---
